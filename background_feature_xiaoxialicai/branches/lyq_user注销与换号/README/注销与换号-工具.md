# 注销与换号-工具  

[TOC]

## 更新记录

| 时间         | 更新人  | 更新内容             |
| :--------- | :--- | :--------------- |
| 2016-06-12 | 梁言庆  | 建立文档             |
| 2016-06-16 | 梁言庆  | 丰富文档，描述清楚各个工具的需求 |
| 2016-06-21 | 梁言庆  | 添加邀请码是否更新的说明     |
|            |      | 添加执行工具后剔除用户的动作   |

## 文档说明

1. 文档中关于交换信息的描述都是针对手机号而言的（除非特别说明），而不是针对userId

### 什么是串号

> 串号是由于共享cookie造成的，两个甚至多个用户的信息会相互混乱，很难理清楚他们的关系。

例如这种情况（**后台展示的工具仅仅处理类似下面的情况**）：A用户登录后B用户也登录了（不考虑还有其他用户的情况），此时他们发生了共享cookie，如果B用户不再进行操作，A用户进行正常的绑卡、充值、购买等，这些操作的数据就会记录到B用户上！下次A用户登录时（此时没有共享cookie了），自己账号就是空白的，而B用户登录后会看到账号下已经进行了绑卡、充值、购买等行为。这种情况我们定义为串号。

------

系统并不能准确的判断哪些用户串号了，只能通过人工、线下、经验结合其他社工方法综合判断  

### 串号需要交换哪些信息

串号只在共享cookie时才会出现，而共享cookie只在系统早期出现过，目前乃至以后的系统几乎不会再出现。  
串号发生后，需要交换两个用户的基础信息。因为系统的手机号与userId对应，userId才对应用户，一般来说只需要交换phone即可。
**邀请码的更换与否取决与是否更新向下的邀请关系（正相关）**  
但是我们还要求一些信息不要交换（不要交换的意义在代码实现上就是再交换一次，因为之前我们交换了手机号），这些不需要交换（即Aphone的还是Aphone）的信息包含：  

- contractId与copartnerId（此两项必须同步，否则对报表系统有影响）  
- 注册日期和时间  
- 登录密码  

### 关于强制剔除用户  
串号、交换、冻结操作执行后，都会剔除此用户在平台上的登录状态，清空用户的所有会话  

## 分析设计

#### 串号交换时更新邀请关系

交换时也要更新向下的邀请关系，比如原来的邀请关系是：A userId -> C userId->D userId，A用户与B用户交换后B userId变成了C userId的父级邀请人，而不是原先的A userId。。。  

#### 串号交换时不更新邀请关系

交换时不更新向下的邀请关系，比如原来的邀请关系是：A userId -> C userId->D userId，交换之后A userId还是C userId的父级邀请人。。。  

#### 交换手机号（换号）

当使用一个全新未注册的phone替换原来的账户时，可以使用此功能。

交换之后，必须使用新的手机号登录账户，且老的手机号可以继续注册（**目前先不考虑该手机号再次注册时被新浪卡住的情况（碰上了通过线下途径把之前的登记信息换掉）**）  
例如：B phone（全新未注册的手机号）交换A user（已经存在的账户），交换之后，Bphone登录后看到的是Auser，而Aphone相当于未注册的手机了（可以继续注册平台）

#### 注销

注销之后，账号在平台上将不能进行任何操作，相当于不存在的账号  

#### 冻结

冻结之后，原账号不能登录了，但是可以进行个别有限的操作（例如？）  

## 详细设计

1. 串号互换时不更新邀请关系  
    适用场景：串号时，不更新向下邀请关系  
2. 串号互换时更新邀请关系  
    适用场景：串号时，也更新两个用户向下的邀请关系  
3. 非串号时交换手机号  
    适用场景：将已存在账号替换到一个未注册（未使用）的账号下  
    处理完成后，转换的登录手机变成新手机号  
4. 手机号注销  
    这个手机号和原来绑定的身份信息可以再次进行注册
5. 手机号冻结  
    账号将不能再登陆 
    手机号和原来绑定的身份信息无法在平台再次注册

## 部署步骤

直接按照安装包中的文件结构，覆盖即可;  